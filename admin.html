<!doctype html>
<html lang="zh-cn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç•™å£°æ´ - ç®¡ç†å‘˜åå°</title>
<style>
* { box-sizing: border-box; }
body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
margin: 0;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: #333;
line-height: 1.6;
min-height: 100vh;
}
.container {
max-width: 1200px;
margin: 0 auto;
padding: 20px;
}
.login-container {
max-width: 400px;
margin: 100px auto;
background: rgba(255, 255, 255, 0.95);
backdrop-filter: blur(10px);
border-radius: 15px;
padding: 40px;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}
.card {
background: rgba(255, 255, 255, 0.95);
backdrop-filter: blur(10px);
border-radius: 15px;
padding: 25px;
margin: 20px 0;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
border: 1px solid rgba(255, 255, 255, 0.2);
}
.card h3 {
margin: 0 0 20px 0;
color: #333;
font-size: 20px;
display: flex;
align-items: center;
gap: 10px;
}
.stats-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
gap: 20px;
margin: 20px 0;
}
.stat-card {
background: linear-gradient(45deg, #667eea, #764ba2);
color: white;
padding: 20px;
border-radius: 12px;
text-align: center;
}
.stat-number {
font-size: 32px;
font-weight: 700;
margin-bottom: 5px;
}
.stat-label {
font-size: 14px;
opacity: 0.9;
}
.btn {
cursor: pointer;
border: none;
background: linear-gradient(45deg, #667eea, #764ba2);
color: white;
padding: 10px 20px;
border-radius: 25px;
font-weight: 500;
transition: all 0.3s ease;
text-decoration: none;
display: inline-block;
}
.btn:hover {
transform: translateY(-2px);
box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}
.btn-secondary {
background: #f8f9fa;
color: #6c757d;
border: 1px solid #dee2e6;
}
.btn-secondary:hover {
background: #e9ecef;
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}
.btn-danger {
background: #dc3545;
}
.btn-danger:hover {
background: #c82333;
box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
}
input[type="text"], input[type="password"] {
width: 100%;
border: 2px solid #e9ecef;
border-radius: 8px;
padding: 12px 15px;
font-size: 14px;
margin: 10px 0;
transition: border-color 0.3s ease;
}
input[type="text"]:focus, input[type="password"]:focus {
outline: none;
border-color: #667eea;
box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}
.table {
width: 100%;
border-collapse: collapse;
margin: 20px 0;
}
.table th, .table td {
padding: 12px;
text-align: left;
border-bottom: 1px solid #e9ecef;
}
.table th {
background: #f8f9fa;
font-weight: 600;
}
.table tr:hover {
background: #f8f9fa;
}
.small {
font-size: 13px;
color: #6c757d;
}
.tip {
padding: 10px 15px;
border-radius: 8px;
margin: 10px 0;
font-size: 14px;
}
.tip.success {
background: #d4edda;
color: #155724;
border: 1px solid #c3e6cb;
}
.tip.error {
background: #f8d7da;
color: #721c24;
border: 1px solid #f5c6cb;
}
.hidden {
display: none;
}
.realtime-indicator {
display: inline-block;
width: 8px;
height: 8px;
background: #28a745;
border-radius: 50%;
margin-right: 8px;
animation: pulse 2s infinite;
}
@keyframes pulse {
0% { opacity: 1; }
50% { opacity: 0.5; }
100% { opacity: 1; }
}
.tabs {
display: flex;
border-bottom: 2px solid #e9ecef;
margin-bottom: 20px;
}
.tab {
padding: 12px 20px;
cursor: pointer;
border-bottom: 2px solid transparent;
transition: all 0.3s ease;
}
.tab.active {
border-bottom-color: #667eea;
color: #667eea;
font-weight: 600;
}
.tab-content {
display: none;
}
.tab-content.active {
display: block;
}
.back-link {
position: fixed;
top: 20px;
left: 20px;
background: rgba(255, 255, 255, 0.9);
padding: 8px 15px;
border-radius: 20px;
text-decoration: none;
color: #667eea;
font-size: 12px;
font-weight: 500;
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}
@media (max-width: 768px) {
.container {
padding: 15px;
}
.stats-grid {
grid-template-columns: 1fr;
}
.table {
font-size: 14px;
}
.back-link {
position: static;
margin: 10px 0;
text-align: center;
}
}
</style>
</head>
<body>
<a href="index.html" class="back-link">â† è¿”å›ä¸»é¡µ</a>

<div class="container">
<!-- ç™»å½•ç•Œé¢ -->
<div id="loginContainer" class="login-container">
<h2 style="text-align: center; margin-bottom: 30px;">ğŸ” ç®¡ç†å‘˜ç™»å½•</h2>
<div id="loginTip"></div>
<form id="loginForm">
<input type="text" id="username" placeholder="ç”¨æˆ·å" required />
<input type="password" id="password" placeholder="å¯†ç " required />
<button type="submit" class="btn" style="width: 100%; margin-top: 10px;">ç™»å½•</button>
</form>
</div>

<!-- ç®¡ç†ç•Œé¢ -->
<div id="adminContainer" class="hidden">
<header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
<h1>ğŸ“Š ç•™å£°æ´ç®¡ç†åå°</h1>
<button class="btn btn-secondary" onclick="logout()">ç™»å‡º</button>
</header>

<div class="tabs">
<div class="tab active" onclick="switchTab('analytics')">ğŸ“ˆ è®¿é—®ç»Ÿè®¡</div>
<div class="tab" onclick="switchTab('posts')">ğŸ“ å†…å®¹ç®¡ç†</div>
<div class="tab" onclick="switchTab('realtime')">âš¡ å®æ—¶ç›‘æ§</div>
</div>

<!-- è®¿é—®ç»Ÿè®¡ -->
<div id="analyticsTab" class="tab-content active">
<div class="card">
<h3>ğŸ“Š è®¿é—®æ¦‚è§ˆ</h3>
<div class="stats-grid">
<div class="stat-card">
<div class="stat-number" id="totalVisits">-</div>
<div class="stat-label">æ€»è®¿é—®é‡</div>
</div>
<div class="stat-card">
<div class="stat-number" id="uniqueVisitors">-</div>
<div class="stat-label">ç‹¬ç«‹è®¿å®¢</div>
</div>
<div class="stat-card">
<div class="stat-number" id="uniqueIPs">-</div>
<div class="stat-label">ç‹¬ç«‹IP</div>
</div>
<div class="stat-card">
<div class="stat-number" id="realtimeVisits">-</div>
<div class="stat-label">å®æ—¶è®¿é—®é‡(5åˆ†é’Ÿ)</div>
</div>
</div>
</div>

<div class="card">
<h3>ğŸ“± è®¾å¤‡ç»Ÿè®¡</h3>
<table class="table">
<thead>
<tr>
<th>è®¾å¤‡å‹å·</th>
<th>è®¿é—®æ¬¡æ•°</th>
<th>å æ¯”</th>
</tr>
</thead>
<tbody id="deviceStats">
</tbody>
</table>
</div>

<div class="card">
<h3>ğŸŒ æµè§ˆå™¨ç»Ÿè®¡</h3>
<table class="table">
<thead>
<tr>
<th>æµè§ˆå™¨å†…æ ¸</th>
<th>è®¿é—®æ¬¡æ•°</th>
<th>å æ¯”</th>
</tr>
</thead>
<tbody id="browserStats">
</tbody>
</table>
</div>

<div class="card">
<h3>ğŸŒ IPåœ°å€ç»Ÿè®¡</h3>
<table class="table">
<thead>
<tr>
<th>IPåœ°å€</th>
<th>è®¿é—®æ¬¡æ•°</th>
<th>å æ¯”</th>
</tr>
</thead>
<tbody id="ipStats">
</tbody>
</table>
</div>
</div>

<!-- å†…å®¹ç®¡ç† -->
<div id="postsTab" class="tab-content">
<div class="card">
<h3>ğŸ“ å¾…å®¡æ ¸å†…å®¹</h3>
<div id="postsList"></div>
</div>
</div>

<!-- å®æ—¶ç›‘æ§ -->
<div id="realtimeTab" class="tab-content">
<div class="card">
<h3><span class="realtime-indicator"></span>å®æ—¶è®¿é—®è®°å½•</h3>
<div id="realtimeList"></div>
</div>
</div>
</div>
</div>

<script src="js/database.js"></script>
<script>
let currentTab = 'analytics';
let refreshInterval;

// ç®¡ç†å‘˜é…ç½®
const ADMIN_USERNAME = 'admin';
const ADMIN_PASSWORD = 'admin123';

// ç­‰å¾…æ•°æ®åº“åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', async () => {
    try {
        await window.db.init();
        await window.db.recordVisit('/admin.html');
        checkLoginStatus();
    } catch (error) {
        console.error('Database initialization failed:', error);
        showTip('æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥', 'error');
    }
});

// æ£€æŸ¥ç™»å½•çŠ¶æ€
function checkLoginStatus() {
    const isLoggedIn = localStorage.getItem('admin_logged_in') === 'true';
    if (isLoggedIn) {
        showAdminInterface();
    } else {
        showLoginInterface();
    }
}

// æ˜¾ç¤ºç™»å½•ç•Œé¢
function showLoginInterface() {
    document.getElementById('loginContainer').classList.remove('hidden');
    document.getElementById('adminContainer').classList.add('hidden');
}

// æ˜¾ç¤ºç®¡ç†ç•Œé¢
function showAdminInterface() {
    document.getElementById('loginContainer').classList.add('hidden');
    document.getElementById('adminContainer').classList.remove('hidden');
    loadAnalytics();
    loadPosts();
    loadRealtime();
    startAutoRefresh();
}

// ç™»å½•
async function login(event) {
    event.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
        localStorage.setItem('admin_logged_in', 'true');
        showTip('ç™»å½•æˆåŠŸ', 'success');
        setTimeout(() => {
            showAdminInterface();
        }, 1000);
    } else {
        showTip('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯', 'error');
    }
}

// ç™»å‡º
function logout() {
    localStorage.removeItem('admin_logged_in');
    showLoginInterface();
    stopAutoRefresh();
}

// åˆ‡æ¢æ ‡ç­¾é¡µ
function switchTab(tabName) {
    // æ›´æ–°æ ‡ç­¾æ ·å¼
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(tabName + 'Tab').classList.add('active');
    currentTab = tabName;

    // åŠ è½½å¯¹åº”æ•°æ®
    if (tabName === 'analytics') {
        loadAnalytics();
    } else if (tabName === 'posts') {
        loadPosts();
    } else if (tabName === 'realtime') {
        loadRealtime();
    }
}

// åŠ è½½ç»Ÿè®¡æ•°æ®
async function loadAnalytics() {
    try {
        const data = await window.db.getAnalytics(24);

        document.getElementById('totalVisits').textContent = data.totalVisits;
        document.getElementById('uniqueVisitors').textContent = data.uniqueVisitors;
        document.getElementById('uniqueIPs').textContent = data.uniqueIPs;
        document.getElementById('realtimeVisits').textContent = data.realtimeVisits;

        // è®¾å¤‡ç»Ÿè®¡
        const deviceStatsBody = document.getElementById('deviceStats');
        deviceStatsBody.innerHTML = '';
        data.deviceStats.forEach(stat => {
            const percentage = data.totalVisits > 0 ? ((stat.count / data.totalVisits) * 100).toFixed(1) : 0;
            deviceStatsBody.innerHTML += `
                <tr>
                    <td>${stat.device_model}</td>
                    <td>${stat.count}</td>
                    <td>${percentage}%</td>
                </tr>
            `;
        });

        // æµè§ˆå™¨ç»Ÿè®¡
        const browserStatsBody = document.getElementById('browserStats');
        browserStatsBody.innerHTML = '';
        data.browserStats.forEach(stat => {
            const percentage = data.totalVisits > 0 ? ((stat.count / data.totalVisits) * 100).toFixed(1) : 0;
            browserStatsBody.innerHTML += `
                <tr>
                    <td>${stat.browser_kernel}</td>
                    <td>${stat.count}</td>
                    <td>${percentage}%</td>
                </tr>
            `;
        });

        // IPç»Ÿè®¡
        const ipStatsBody = document.getElementById('ipStats');
        ipStatsBody.innerHTML = '';
        data.ipStats.forEach(stat => {
            const percentage = data.totalVisits > 0 ? ((stat.count / data.totalVisits) * 100).toFixed(1) : 0;
            ipStatsBody.innerHTML += `
                <tr>
                    <td>${stat.ip_address}</td>
                    <td>${stat.count}</td>
                    <td>${percentage}%</td>
                </tr>
            `;
        });
    } catch (error) {
        console.error('Analytics load error:', error);
    }
}

// åŠ è½½å¸–å­åˆ—è¡¨
async function loadPosts() {
    try {
        const data = await window.db.getPendingPosts();

        const postsList = document.getElementById('postsList');
        if (data.list.length === 0) {
            postsList.innerHTML = '<p style="text-align: center; color: #6c757d;">æš‚æ— å¾…å®¡æ ¸å†…å®¹</p>';
            return;
        }

        postsList.innerHTML = '';
        data.list.forEach(post => {
            const postDiv = document.createElement('div');
            postDiv.className = 'card';
            postDiv.style.marginBottom = '15px';
            postDiv.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <strong>ID:</strong> ${post.id} | 
                    <strong>æ—¶é—´:</strong> ${new Date(post.created_at * 1000).toLocaleString()}
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; white-space: pre-wrap;">${escapeHtml(post.content)}</div>
                <div>
                    <button class="btn" onclick="approvePost(${post.id})">âœ… é€šè¿‡</button>
                    <button class="btn btn-danger" onclick="rejectPost(${post.id})">âŒ æ‹’ç»</button>
                    <button class="btn btn-secondary" onclick="deletePost(${post.id})">ğŸ—‘ï¸ åˆ é™¤</button>
                </div>
            `;
            postsList.appendChild(postDiv);
        });
    } catch (error) {
        console.error('Posts load error:', error);
    }
}

// åŠ è½½å®æ—¶æ•°æ®
async function loadRealtime() {
    try {
        const data = await window.db.getAnalytics(1); // æœ€è¿‘1å°æ—¶

        const realtimeList = document.getElementById('realtimeList');
        if (data.recentVisits.length === 0) {
            realtimeList.innerHTML = '<p style="text-align: center; color: #6c757d;">æš‚æ— è®¿é—®è®°å½•</p>';
            return;
        }

        realtimeList.innerHTML = '';
        data.recentVisits.slice(0, 20).forEach(visit => {
            const visitDiv = document.createElement('div');
            visitDiv.style.cssText = 'padding: 10px; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center;';
            visitDiv.innerHTML = `
                <div>
                    <strong>${visit.ip_address}</strong> | 
                    ${visit.device_model} | 
                    ${visit.browser_kernel} | 
                    ${visit.page_path}
                </div>
                <div class="small">${new Date(visit.created_at * 1000).toLocaleString()}</div>
            `;
            realtimeList.appendChild(visitDiv);
        });
    } catch (error) {
        console.error('Realtime load error:', error);
    }
}

// å®¡æ ¸å¸–å­
async function approvePost(id) {
    try {
        await window.db.approvePost(id);
        showTip('å¸–å­å·²é€šè¿‡å®¡æ ¸', 'success');
        loadPosts();
    } catch (error) {
        console.error('Approve error:', error);
        showTip('æ“ä½œå¤±è´¥', 'error');
    }
}

async function rejectPost(id) {
    try {
        await window.db.rejectPost(id);
        showTip('å¸–å­å·²æ‹’ç»', 'success');
        loadPosts();
    } catch (error) {
        console.error('Reject error:', error);
        showTip('æ“ä½œå¤±è´¥', 'error');
    }
}

async function deletePost(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¸–å­å—ï¼Ÿ')) return;
    try {
        await window.db.deletePost(id);
        showTip('å¸–å­å·²åˆ é™¤', 'success');
        loadPosts();
    } catch (error) {
        console.error('Delete error:', error);
        showTip('æ“ä½œå¤±è´¥', 'error');
    }
}

// è‡ªåŠ¨åˆ·æ–°
function startAutoRefresh() {
    refreshInterval = setInterval(() => {
        if (currentTab === 'analytics') {
            loadAnalytics();
        } else if (currentTab === 'realtime') {
            loadRealtime();
        } else if (currentTab === 'posts') {
            loadPosts();
        }
    }, 3000); // æ¯3ç§’åˆ·æ–°ä¸€æ¬¡
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
}

function showTip(message, type) {
    const tip = document.getElementById('loginTip');
    tip.innerHTML = message;
    tip.className = `tip ${type}`;
    setTimeout(() => {
        tip.innerHTML = '';
        tip.className = '';
    }, 3000);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// åˆå§‹åŒ–
document.getElementById('loginForm').addEventListener('submit', login);
</script>
</body>
</html>
