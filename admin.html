<!doctype html>
<html lang="zh-cn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>留声洞 - 管理员后台</title>
<style>
* { box-sizing: border-box; }
body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
margin: 0;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: #333;
line-height: 1.6;
min-height: 100vh;
}
.container {
max-width: 1200px;
margin: 0 auto;
padding: 20px;
}
.login-container {
max-width: 400px;
margin: 100px auto;
background: rgba(255, 255, 255, 0.95);
backdrop-filter: blur(10px);
border-radius: 15px;
padding: 40px;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}
.card {
background: rgba(255, 255, 255, 0.95);
backdrop-filter: blur(10px);
border-radius: 15px;
padding: 25px;
margin: 20px 0;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
border: 1px solid rgba(255, 255, 255, 0.2);
}
.card h3 {
margin: 0 0 20px 0;
color: #333;
font-size: 20px;
display: flex;
align-items: center;
gap: 10px;
}
.stats-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
gap: 20px;
margin: 20px 0;
}
.stat-card {
background: linear-gradient(45deg, #667eea, #764ba2);
color: white;
padding: 20px;
border-radius: 12px;
text-align: center;
}
.stat-number {
font-size: 32px;
font-weight: 700;
margin-bottom: 5px;
}
.stat-label {
font-size: 14px;
opacity: 0.9;
}
.btn {
cursor: pointer;
border: none;
background: linear-gradient(45deg, #667eea, #764ba2);
color: white;
padding: 10px 20px;
border-radius: 25px;
font-weight: 500;
transition: all 0.3s ease;
text-decoration: none;
display: inline-block;
}
.btn:hover {
transform: translateY(-2px);
box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}
.btn-secondary {
background: #f8f9fa;
color: #6c757d;
border: 1px solid #dee2e6;
}
.btn-secondary:hover {
background: #e9ecef;
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}
.btn-danger {
background: #dc3545;
}
.btn-danger:hover {
background: #c82333;
box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
}
input[type="text"], input[type="password"] {
width: 100%;
border: 2px solid #e9ecef;
border-radius: 8px;
padding: 12px 15px;
font-size: 14px;
margin: 10px 0;
transition: border-color 0.3s ease;
}
input[type="text"]:focus, input[type="password"]:focus {
outline: none;
border-color: #667eea;
box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}
.table {
width: 100%;
border-collapse: collapse;
margin: 20px 0;
}
.table th, .table td {
padding: 12px;
text-align: left;
border-bottom: 1px solid #e9ecef;
}
.table th {
background: #f8f9fa;
font-weight: 600;
}
.table tr:hover {
background: #f8f9fa;
}
.small {
font-size: 13px;
color: #6c757d;
}
.tip {
padding: 10px 15px;
border-radius: 8px;
margin: 10px 0;
font-size: 14px;
}
.tip.success {
background: #d4edda;
color: #155724;
border: 1px solid #c3e6cb;
}
.tip.error {
background: #f8d7da;
color: #721c24;
border: 1px solid #f5c6cb;
}
.hidden {
display: none;
}
.realtime-indicator {
display: inline-block;
width: 8px;
height: 8px;
background: #28a745;
border-radius: 50%;
margin-right: 8px;
animation: pulse 2s infinite;
}
@keyframes pulse {
0% { opacity: 1; }
50% { opacity: 0.5; }
100% { opacity: 1; }
}
.tabs {
display: flex;
border-bottom: 2px solid #e9ecef;
margin-bottom: 20px;
}
.tab {
padding: 12px 20px;
cursor: pointer;
border-bottom: 2px solid transparent;
transition: all 0.3s ease;
}
.tab.active {
border-bottom-color: #667eea;
color: #667eea;
font-weight: 600;
}
.tab-content {
display: none;
}
.tab-content.active {
display: block;
}
@media (max-width: 768px) {
.container {
padding: 15px;
}
.stats-grid {
grid-template-columns: 1fr;
}
.table {
font-size: 14px;
}
}
</style>
</head>
<body>
<div class="container">
<!-- 登录界面 -->
<div id="loginContainer" class="login-container">
<h2 style="text-align: center; margin-bottom: 30px;">🔐 管理员登录</h2>
<div id="loginTip"></div>
<form id="loginForm">
<input type="text" id="username" placeholder="用户名" required />
<input type="password" id="password" placeholder="密码" required />
<button type="submit" class="btn" style="width: 100%; margin-top: 10px;">登录</button>
</form>
</div>

<!-- 管理界面 -->
<div id="adminContainer" class="hidden">
<header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
<h1>📊 留声洞管理后台</h1>
<button class="btn btn-secondary" onclick="logout()">登出</button>
</header>

<div class="tabs">
<div class="tab active" onclick="switchTab('analytics')">📈 访问统计</div>
<div class="tab" onclick="switchTab('posts')">📝 内容管理</div>
<div class="tab" onclick="switchTab('realtime')">⚡ 实时监控</div>
</div>

<!-- 访问统计 -->
<div id="analyticsTab" class="tab-content active">
<div class="card">
<h3>📊 访问概览</h3>
<div class="stats-grid">
<div class="stat-card">
<div class="stat-number" id="totalVisits">-</div>
<div class="stat-label">总访问量</div>
</div>
<div class="stat-card">
<div class="stat-number" id="uniqueVisitors">-</div>
<div class="stat-label">独立访客</div>
</div>
<div class="stat-card">
<div class="stat-number" id="uniqueIPs">-</div>
<div class="stat-label">独立IP</div>
</div>
</div>
</div>

<div class="card">
<h3>📱 设备统计</h3>
<table class="table">
<thead>
<tr>
<th>设备型号</th>
<th>访问次数</th>
<th>占比</th>
</tr>
</thead>
<tbody id="deviceStats">
</tbody>
</table>
</div>

<div class="card">
<h3>🌐 浏览器统计</h3>
<table class="table">
<thead>
<tr>
<th>浏览器内核</th>
<th>访问次数</th>
<th>占比</th>
</tr>
</thead>
<tbody id="browserStats">
</tbody>
</table>
</div>
</div>

<!-- 内容管理 -->
<div id="postsTab" class="tab-content">
<div class="card">
<h3>📝 待审核内容</h3>
<div id="postsList"></div>
</div>
</div>

<!-- 实时监控 -->
<div id="realtimeTab" class="tab-content">
<div class="card">
<h3><span class="realtime-indicator"></span>实时访问记录</h3>
<div id="realtimeList"></div>
</div>
</div>
</div>
</div>

<script>
let currentTab = 'analytics';
let refreshInterval;

// 检查登录状态
async function checkLoginStatus() {
try {
const response = await fetch('/api/admin/status');
const data = await response.json();
if (data.loggedIn) {
showAdminInterface();
} else {
showLoginInterface();
}
} catch (error) {
showLoginInterface();
}
}

// 显示登录界面
function showLoginInterface() {
document.getElementById('loginContainer').classList.remove('hidden');
document.getElementById('adminContainer').classList.add('hidden');
}

// 显示管理界面
function showAdminInterface() {
document.getElementById('loginContainer').classList.add('hidden');
document.getElementById('adminContainer').classList.remove('hidden');
loadAnalytics();
loadPosts();
loadRealtime();
startAutoRefresh();
}

// 登录
async function login(event) {
event.preventDefault();
const username = document.getElementById('username').value;
const password = document.getElementById('password').value;

try {
const response = await fetch('/api/admin/login', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ username, password })
});

if (response.ok) {
showTip('登录成功', 'success');
setTimeout(() => {
showAdminInterface();
}, 1000);
} else {
const data = await response.json();
showTip(data.error || '登录失败', 'error');
}
} catch (error) {
showTip('网络错误，请重试', 'error');
}
}

// 登出
async function logout() {
try {
await fetch('/api/admin/logout', { method: 'POST' });
showLoginInterface();
stopAutoRefresh();
} catch (error) {
console.error('Logout error:', error);
}
}

// 切换标签页
function switchTab(tabName) {
// 更新标签样式
document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
event.target.classList.add('active');
document.getElementById(tabName + 'Tab').classList.add('active');
currentTab = tabName;

// 加载对应数据
if (tabName === 'analytics') {
loadAnalytics();
} else if (tabName === 'posts') {
loadPosts();
} else if (tabName === 'realtime') {
loadRealtime();
}
}

// 加载统计数据
async function loadAnalytics() {
try {
const response = await fetch('/api/admin/analytics?timeRange=24');
const data = await response.json();

document.getElementById('totalVisits').textContent = data.totalVisits;
document.getElementById('uniqueVisitors').textContent = data.uniqueVisitors;
document.getElementById('uniqueIPs').textContent = data.uniqueIPs;

// 设备统计
const deviceStatsBody = document.getElementById('deviceStats');
deviceStatsBody.innerHTML = '';
data.deviceStats.forEach(stat => {
const percentage = ((stat.count / data.totalVisits) * 100).toFixed(1);
deviceStatsBody.innerHTML += `
<tr>
<td>${stat.device_model}</td>
<td>${stat.count}</td>
<td>${percentage}%</td>
</tr>
`;
});

// 浏览器统计
const browserStatsBody = document.getElementById('browserStats');
browserStatsBody.innerHTML = '';
data.browserStats.forEach(stat => {
const percentage = ((stat.count / data.totalVisits) * 100).toFixed(1);
browserStatsBody.innerHTML += `
<tr>
<td>${stat.browser_kernel}</td>
<td>${stat.count}</td>
<td>${percentage}%</td>
</tr>
`;
});
} catch (error) {
console.error('Analytics load error:', error);
}
}

// 加载帖子列表
async function loadPosts() {
try {
const response = await fetch('/api/admin/posts?status=pending');
const data = await response.json();

const postsList = document.getElementById('postsList');
if (data.list.length === 0) {
postsList.innerHTML = '<p style="text-align: center; color: #6c757d;">暂无待审核内容</p>';
return;
}

postsList.innerHTML = '';
data.list.forEach(post => {
const postDiv = document.createElement('div');
postDiv.className = 'card';
postDiv.style.marginBottom = '15px';
postDiv.innerHTML = `
<div style="margin-bottom: 15px;">
<strong>ID:</strong> ${post.id} | 
<strong>时间:</strong> ${new Date(post.created_at * 1000).toLocaleString()}
</div>
<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; white-space: pre-wrap;">${escapeHtml(post.content)}</div>
<div>
<button class="btn" onclick="approvePost(${post.id})">✅ 通过</button>
<button class="btn btn-danger" onclick="rejectPost(${post.id})">❌ 拒绝</button>
<button class="btn btn-secondary" onclick="deletePost(${post.id})">🗑️ 删除</button>
</div>
`;
postsList.appendChild(postDiv);
});
} catch (error) {
console.error('Posts load error:', error);
}
}

// 加载实时数据
async function loadRealtime() {
try {
const response = await fetch('/api/admin/realtime?limit=20');
const data = await response.json();

const realtimeList = document.getElementById('realtimeList');
if (data.visits.length === 0) {
realtimeList.innerHTML = '<p style="text-align: center; color: #6c757d;">暂无访问记录</p>';
return;
}

realtimeList.innerHTML = '';
data.visits.forEach(visit => {
const visitDiv = document.createElement('div');
visitDiv.style.cssText = 'padding: 10px; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center;';
visitDiv.innerHTML = `
<div>
<strong>${visit.ip_address}</strong> | 
${visit.device_model} | 
${visit.browser_kernel} | 
${visit.page_path}
</div>
<div class="small">${new Date(visit.created_at * 1000).toLocaleString()}</div>
`;
realtimeList.appendChild(visitDiv);
});
} catch (error) {
console.error('Realtime load error:', error);
}
}

// 审核帖子
async function approvePost(id) {
try {
await fetch('/api/admin/approve', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ id })
});
showTip('帖子已通过审核', 'success');
loadPosts();
} catch (error) {
showTip('操作失败', 'error');
}
}

async function rejectPost(id) {
try {
await fetch('/api/admin/reject', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ id })
});
showTip('帖子已拒绝', 'success');
loadPosts();
} catch (error) {
showTip('操作失败', 'error');
}
}

async function deletePost(id) {
if (!confirm('确定要删除这条帖子吗？')) return;
try {
await fetch('/api/admin/delete', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ id })
});
showTip('帖子已删除', 'success');
loadPosts();
} catch (error) {
showTip('操作失败', 'error');
}
}

// 自动刷新
function startAutoRefresh() {
refreshInterval = setInterval(() => {
if (currentTab === 'analytics') {
loadAnalytics();
} else if (currentTab === 'realtime') {
loadRealtime();
}
}, 5000); // 每5秒刷新一次
}

function stopAutoRefresh() {
if (refreshInterval) {
clearInterval(refreshInterval);
}
}

function showTip(message, type) {
const tip = document.getElementById('loginTip');
tip.innerHTML = message;
tip.className = `tip ${type}`;
setTimeout(() => {
tip.innerHTML = '';
tip.className = '';
}, 3000);
}

function escapeHtml(text) {
const div = document.createElement('div');
div.textContent = text;
return div.innerHTML;
}

// 初始化
document.getElementById('loginForm').addEventListener('submit', login);
checkLoginStatus();
</script>
</body>
</html>